<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Transmissão WhatsApp | Centro Social</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --wa-bg: #f0f2f5; --wa-green: #00a884; --sidebar-bg: #1e293b; }
        body { background-color: var(--wa-bg); font-family: 'Inter', sans-serif; height: 100vh; overflow: hidden; }
        
        .main-wrapper { display: flex; height: 100vh; }
        
        /* Menu Lateral Sistema */
        .sidebar { width: 80px; background: var(--sidebar-bg); display: flex; flex-direction: column; align-items: center; padding: 20px 0; }
        .sidebar .nav-link { color: #94a3b8; font-size: 1.5rem; margin-bottom: 25px; transition: 0.3s; }
        .sidebar .nav-link.active { color: #fff; }

        /* Painel de Filtros */
        .filter-panel { width: 350px; background: #fff; border-right: 1px solid #d1d7db; display: flex; flex-direction: column; }
        .filter-header { padding: 20px; background: #f0f2f5; border-bottom: 1px solid #d1d7db; }
        .filter-body { padding: 20px; overflow-y: auto; flex-grow: 1; }

        /* Área do Chat */
        .chat-area { flex-grow: 1; display: flex; flex-direction: column; background: #efeae2; position: relative; }
        .chat-area::before { content: ""; position: absolute; top: 0; left: 0; width: 100%; height: 100%; opacity: 0.06; background-image: url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png'); pointer-events: none; }

        .chat-header { padding: 15px 25px; background: #f0f2f5; border-bottom: 1px solid #d1d7db; z-index: 10; display: flex; align-items: center; }
        .chat-footer { padding: 20px 60px; background: #f0f2f5; z-index: 10; }
        
        .message-box { background: #fff; border-radius: 15px; padding: 20px; box-shadow: 0 1px 0.5px rgba(11,20,26,.13); position: relative; z-index: 10; width: 80%; margin: 20px auto; }
        .textarea-wa { width: 100%; border: none; outline: none; resize: none; min-height: 100px; font-size: 1rem; }

        .btn-send { background: var(--wa-green); color: white; border: none; border-radius: 50%; width: 50px; height: 50px; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; transition: 0.3s; }
        .btn-send:hover { transform: scale(1.1); background: #019475; }

        .destinatarios-badge { background: #e7fce3; color: #1fa855; border-radius: 20px; padding: 5px 15px; font-weight: 600; font-size: 0.8rem; margin-top: 10px; display: inline-block; }
    </style>
</head>
<body>

    <div class="main-wrapper">
        <nav class="sidebar">
            <a href="dashboard.html" class="nav-link"><i class="fas fa-chart-line"></i></a>
            <a href="projetos.html" class="nav-link"><i class="fas fa-folder"></i></a>
            <a href="enviar_mensagens.html" class="nav-link active"><i class="fab fa-whatsapp"></i></a>
        </nav>

        <aside class="filter-panel">
            <div class="filter-header">
                <h5 class="fw-bold mb-0">Nova Transmissão</h5>
                <p class="text-muted small mb-0">Selecione quem receberá a mensagem</p>
            </div>
            
            <div class="filter-body">
                <div class="mb-4">
                    <label class="form-label small fw-bold text-muted">1. TIPO DE ENVIO</label>
                    <select class="form-select" id="tipoEnvio" onchange="alternarFiltros(this.value)">
                        <option value="aluno">Individual (Por Aluno)</option>
                        <option value="turma">Por Turma</option>
                        <option value="projeto">Por Projeto</option>
                    </select>
                </div>

                <div id="campoProjeto" class="mb-4" style="display:none;">
                    <label class="form-label small fw-bold text-muted">2. SELECIONE O PROJETO</label>
                    <select class="form-select" id="selectProjeto" onchange="atualizarContagem()">
                        <option value="">Escolha o Projeto...</option>
                        <option value="1">Adolescer para Crescer</option>
                        <option value="2">Criança Certeza</option>
                        <option value="3">Sempre Criança</option>
                        <option value="4">Valorizando a Infância</option>
                        <option value="5">Clube de Mães</option>
                        <option value="6">Animar e Celebrar</option>
                    </select>
                </div>

                <div id="campoTurma" class="mb-4" style="display:none;">
                    <label class="form-label small fw-bold text-muted">2. SELECIONE A TURMA</label>
                    <select class="form-select" id="selectTurma" onchange="atualizarContagem()">
                        <option value="">Aguardando Projeto...</option>
                    </select>
                </div>

                <div id="campoAluno" class="mb-4">
                    <label class="form-label small fw-bold text-muted">2. PESQUISAR ALUNO</label>
                    <input type="text" class="form-control" placeholder="Digite o nome..." onkeyup="buscarAluno(this.value)">
                    <div id="listaAlunosBusca" class="list-group mt-2 shadow-sm"></div>
                </div>

                <div class="mt-5 p-3 bg-light rounded border">
                    <h6 class="fw-bold small mb-1">Resumo do Público:</h6>
                    <div id="contagemDestinatarios" class="destinatarios-badge">0 destinatários selecionados</div>
                </div>
            </div>
        </aside>

        <section class="chat-area">
            <header class="chat-header">
                <div class="d-flex align-items-center">
                    <div class="bg-success rounded-circle d-flex align-items-center justify-content-center text-white me-3" style="width: 45px; height: 45px;">
                        <i class="fab fa-whatsapp fa-lg"></i>
                    </div>
                    <div>
                        <h6 class="fw-bold mb-0">Mensagem de Transmissão</h6>
                        <small class="text-muted">Status do Servidor: <span class="text-danger">Desconectado</span></small>
                    </div>
                </div>
            </header>

            <div class="flex-grow-1 d-flex flex-column justify-content-center">
                <div class="message-box">
                    <textarea class="textarea-wa" id="msgWhatsapp" placeholder="Digite aqui o aviso para os alunos..."></textarea>
                    <div class="text-end mt-2">
                        <small class="text-muted">Use [nome] para personalizar</small>
                    </div>
                </div>
            </div>

            <footer class="chat-footer">
                <div class="d-flex align-items-center justify-content-between">
                    <div class="text-muted small">
                        <i class="fas fa-info-circle me-1"></i> As mensagens serão enviadas individualmente para respeitar a privacidade.
                    </div>
                    <button class="btn-send" onclick="prepararEnvio()">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </footer>
        </section>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        const SUPABASE_URL = 'https://paadzisqttrkbscehcmh.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_FQsB5Jx26X9H6eD77heXtw_jzda0lcC';
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let destinatarios = [];

        function alternarFiltros(tipo) {
            document.getElementById('campoAluno').style.display = tipo === 'aluno' ? 'block' : 'none';
            document.getElementById('campoProjeto').style.display = (tipo === 'projeto' || tipo === 'turma') ? 'block' : 'none';
            document.getElementById('campoTurma').style.display = tipo === 'turma' ? 'block' : 'none';
            destinatarios = [];
            atualizarContagem();
        }

        // Simulação da lógica de busca para interface
        async function atualizarContagem() {
            const tipo = document.getElementById('tipoEnvio').value;
            const projId = document.getElementById('selectProjeto').value;
            const badge = document.getElementById('contagemDestinatarios');
            
            badge.innerText = "Calculando...";
            
            // Aqui entra a lógica de Select no Supabase para contar quantos alunos têm aquele ID de projeto ou turma
            // Por enquanto, apenas para visualização da interface:
            setTimeout(() => {
                badge.innerText = "Pronto para enviar";
            }, 500);
        }

        function prepararEnvio() {
            const msg = document.getElementById('msgWhatsapp').value;
            if(!msg) { alert("Escreva uma mensagem!"); return; }
            alert("Interface Pronta! Agora precisamos configurar o 'motor' de envio.");
        }
    </script>
</body>
</html>
