<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Transmissão WhatsApp | Centro Social</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --wa-bg: #f0f2f5; --wa-green: #00a884; --sidebar-bg: #1e293b; --primary: #3b82f6; }
        body { background-color: var(--wa-bg); font-family: 'Inter', sans-serif; height: 100vh; overflow: hidden; margin: 0; }
        
        .main-wrapper { display: flex; height: 100vh; }

        /* MENU LATERAL PADRONIZADO */
        .sidebar { width: 240px; height: 100vh; background: var(--sidebar-bg); padding: 20px 0; flex-shrink: 0; }
        .sidebar .nav-link { color: #94a3b8; padding: 12px 25px; font-size: 0.9rem; text-decoration: none; display: block; transition: 0.3s; }
        .sidebar .nav-link:hover { color: #fff; background: rgba(255,255,255,0.1); }
        .sidebar .nav-link.active { color: #fff; background: var(--primary); font-weight: 600; }
        .sidebar-logo { color: white; font-weight: 700; padding: 0 25px 30px 25px; display: block; font-size: 1.2rem; }

        /* RESTANTE DO LAYOUT PRESERVADO */
        .filter-panel { width: 350px; background: #fff; border-right: 1px solid #d1d7db; display: flex; flex-direction: column; z-index: 20; }
        .filter-header { padding: 20px; background: #f0f2f5; border-bottom: 1px solid #d1d7db; }
        .filter-body { padding: 20px; overflow-y: auto; flex-grow: 1; }
        .chat-area { flex-grow: 1; display: flex; flex-direction: column; background: #efeae2; position: relative; }
        .chat-area::before { content: ""; position: absolute; top: 0; left: 0; width: 100%; height: 100%; opacity: 0.06; background-image: url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png'); pointer-events: none; }
        .chat-header { padding: 15px 25px; background: #f0f2f5; border-bottom: 1px solid #d1d7db; z-index: 10; display: flex; align-items: center; justify-content: space-between; }
        .chat-footer { padding: 20px 60px; background: #f0f2f5; z-index: 10; }
        .message-box { background: #fff; border-radius: 15px; padding: 20px; box-shadow: 0 1px 0.5px rgba(11,20,26,.13); position: relative; z-index: 10; width: 80%; margin: 20px auto; }
        .textarea-wa { width: 100%; border: none; outline: none; resize: none; min-height: 150px; font-size: 1rem; }
        .btn-send { background: var(--wa-green); color: white; border: none; border-radius: 50%; width: 55px; height: 55px; display: flex; align-items: center; justify-content: center; font-size: 1.3rem; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .destinatarios-badge { background: #e7fce3; color: #1fa855; border-radius: 20px; padding: 8px 15px; font-weight: 700; font-size: 0.85rem; margin-top: 10px; display: block; text-align: center; border: 1px solid #c3e6cb; }
        .search-result-item { padding: 10px; cursor: pointer; border-bottom: 1px solid #eee; font-size: 0.9rem; }
        .search-result-item:hover { background: #f8fafc; color: #3b82f6; }
    </style>
</head>
<body>

    <div class="main-wrapper">
        <aside class="sidebar">
            <div class="sidebar-logo">
                <i class="fas fa-graduation-cap me-2"></i>Centro Social
            </div>
            <nav>
                <a class="nav-link" href="dashboard.html"><i class="fas fa-chart-line me-2"></i> Dashboard</a>
                <a class="nav-link" href="lista_geral.html"><i class="fas fa-list me-2"></i> Lista Geral</a>
                <a class="nav-link" href="projetos.html"><i class="fas fa-folder me-2"></i> Projetos</a>
                <a class="nav-link" href="turmas.html"><i class="fas fa-users me-2"></i> Turmas</a>
                <a class="nav-link" href="cadastro.html"><i class="fas fa-user-plus me-2"></i> Novo Aluno</a>
                <a class="nav-link active" href="enviar_mensagens.html"><i class="fab fa-whatsapp me-2"></i> Transmissão</a>
                
                <div class="mt-5 px-4">
                    <button class="btn btn-sm btn-outline-danger w-100 opacity-75" onclick="logout()" style="font-size: 0.8rem;">
                        <i class="fas fa-sign-out-alt me-1"></i> Sair do Sistema
                    </button>
                </div>
            </nav>
        </aside>

        <aside class="filter-panel">
            <div class="filter-header">
                <h5 class="fw-bold mb-0">Transmissão</h5>
                <p class="text-muted small mb-0">Selecione o público-alvo</p>
            </div>
            
            <div class="filter-body">
                <div class="mb-4">
                    <label class="form-label small fw-bold text-muted">MÉTODO DE ENVIO</label>
                    <select class="form-select" id="tipoEnvio" onchange="alternarFiltros(this.value)">
                        <option value="aluno">Individual (Por Aluno)</option>
                        <option value="turma">Por Turma</option>
                        <option value="projeto">Por Projeto</option>
                    </select>
                </div>

                <div id="campoProjeto" class="mb-4" style="display:none;">
                    <label class="form-label small fw-bold text-muted">PROJETO</label>
                    <select class="form-select" id="selectProjeto" onchange="buscarDadosEnvio()">
                        <option value="">Selecione...</option>
                        <option value="1">Adolescer para Crescer</option>
                        <option value="2">Criança Certeza</option>
                        <option value="3">Sempre Criança</option>
                        <option value="4">Valorizando a Infância</option>
                        <option value="5">Clube de Mães</option>
                        <option value="6">Animar e Celebrar</option>
                    </select>
                </div>

                <div id="campoTurma" class="mb-4" style="display:none;">
                    <label class="form-label small fw-bold text-muted">TURMA</label>
                    <select class="form-select" id="selectTurma" onchange="buscarDadosEnvio()">
                        <option value="">Aguardando Projeto...</option>
                    </select>
                </div>

                <div id="campoAluno" class="mb-4">
                    <label class="form-label small fw-bold text-muted">PESQUISAR NOME</label>
                    <input type="text" id="inputBuscaAluno" class="form-control" placeholder="Digite para buscar..." onkeyup="pesquisarAlunoIndividual(this.value)">
                    <div id="listaAlunosBusca" class="list-group mt-2 border shadow-sm" style="max-height: 200px; overflow-y: auto; display: none; background: white;"></div>
                </div>

                <div class="mt-4">
                    <div id="contagemDestinatarios" class="destinatarios-badge">0 destinatários selecionados</div>
                    <div id="listaNomes" class="text-muted small mt-2 px-2" style="max-height: 150px; overflow-y: auto;"></div>
                </div>
            </div>
        </aside>

        <section class="chat-area">
            <header class="chat-header">
                <div class="d-flex align-items-center">
                    <div class="bg-success rounded-circle d-flex align-items-center justify-content-center text-white me-3" style="width: 45px; height: 45px;">
                        <i class="fab fa-whatsapp fa-lg"></i>
                    </div>
                    <div>
                        <h6 class="fw-bold mb-0">Compor Mensagem</h6>
                        <small class="text-muted" id="statusEnvio">Pronto para disparar</small>
                    </div>
                </div>
                <button class="btn btn-sm btn-outline-secondary" onclick="abrirModalConexao()"><i class="fas fa-qrcode me-2"></i>Conectar WhatsApp</button>
            </header>

            <div class="flex-grow-1 d-flex flex-column justify-content-center">
                <div class="message-box">
                    <textarea class="textarea-wa" id="msgWhatsapp" placeholder="Olá [nome], gostaríamos de informar que..."></textarea>
                </div>
            </div>

            <footer class="chat-footer">
                <div class="d-flex align-items-center justify-content-between">
                    <div class="text-muted small">Dica: Use <b>[nome]</b> para personalizar a mensagem.</div>
                    <button class="btn-send" onclick="dispararMensagens()">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </footer>
        </section>
    </div>

    <div class="modal fade" id="modalQR" tabindex="-1">
        <div class="modal-dialog modal-sm modal-dialog-centered">
            <div class="modal-content text-center p-4">
                <h6 class="fw-bold">Conectar Servidor</h6>
                <div id="areaQR" class="my-3"><div class="spinner-border text-primary"></div></div>
                <p class="small text-muted">Escaneie o código com seu WhatsApp para ativar o envio automático.</p>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        const SUPABASE_URL = 'https://paadzisqttrkbscehcmh.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_FQsB5Jx26X9H6eD77heXtw_jzda0lcC';
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        const API_URL = "https://transparency-font-agrees-purposes.trycloudflare.com"; 
        const API_KEY = "minha_chave_secreta";
        const INSTANCE = "CentroSocial";

        let listaDestinatarios = [];

        function alternarFiltros(tipo) {
            document.getElementById('campoAluno').style.display = tipo === 'aluno' ? 'block' : 'none';
            document.getElementById('campoProjeto').style.display = (tipo === 'projeto' || tipo === 'turma') ? 'block' : 'none';
            document.getElementById('campoTurma').style.display = tipo === 'turma' ? 'block' : 'none';
            listaDestinatarios = [];
            atualizarInterfaceContagem();
        }

        async function pesquisarAlunoIndividual(termo) {
            const resDiv = document.getElementById('listaAlunosBusca');
            if (termo.length < 3) { resDiv.style.display = 'none'; return; }
            const { data } = await supabaseClient.from('alunos').select('nome, whatsapp').ilike('nome', `%${termo}%`).limit(5);
            if (data) {
                resDiv.innerHTML = data.map(a => `<div class="search-result-item" onclick="selecionarAluno('${a.nome}', '${a.whatsapp}')">${a.nome}</div>`).join('');
                resDiv.style.display = 'block';
            }
        }

        function selecionarAluno(nome, whatsapp) {
            listaDestinatarios = [{ nome, whatsapp }];
            document.getElementById('listaAlunosBusca').style.display = 'none';
            document.getElementById('inputBuscaAluno').value = nome;
            atualizarInterfaceContagem();
        }

        async function buscarDadosEnvio() {
            const tipo = document.getElementById('tipoEnvio').value;
            const projId = document.getElementById('selectProjeto').value;
            const turmaId = document.getElementById('selectTurma').value;
            if (!projId) return;

            if (tipo === 'turma' && !turmaId) {
                const { data: turmas } = await supabaseClient.from('turmas').select('id, nome_turma').eq('projeto_id', projId);
                const st = document.getElementById('selectTurma');
                st.innerHTML = '<option value="">Escolha a Turma...</option>';
                turmas.forEach(t => st.add(new Option(t.nome_turma, t.id)));
                return;
            }

            let query = supabaseClient.from('alunos').select('nome, whatsapp');
            if (tipo === 'projeto') query = query.eq('projetos', projId);
            else if (tipo === 'turma' && turmaId) {
                const { data: mats } = await supabaseClient.from('matriculas').select('alunos(nome, whatsapp)').eq('turma_id', turmaId);
                listaDestinatarios = mats.filter(m => m.alunos).map(m => ({ nome: m.alunos.nome, whatsapp: m.alunos.whatsapp }));
                atualizarInterfaceContagem(); return;
            }
            const { data } = await query;
            listaDestinatarios = data || [];
            atualizarInterfaceContagem();
        }

        function atualizarInterfaceContagem() {
            document.getElementById('contagemDestinatarios').innerText = `${listaDestinatarios.length} selecionados`;
            document.getElementById('listaNomes').innerHTML = listaDestinatarios.map(d => `<div>• ${d.nome}</div>`).join('');
        }

        async function dispararMensagens() {
            const msgBase = document.getElementById('msgWhatsapp').value;
            const statusLabel = document.getElementById('statusEnvio');
            if (listaDestinatarios.length === 0 || !msgBase) { alert("Preencha os dados!"); return; }

            if(!confirm(`Iniciar envio para ${listaDestinatarios.length} pessoas?`)) return;

            for (let i = 0; i < listaDestinatarios.length; i++) {
                const aluno = listaDestinatarios[i];
                if (!aluno.whatsapp) continue;
                
                let fone = aluno.whatsapp.replace(/\D/g, '');
                if (fone.length === 11) fone = "55" + fone;

                const msgFinal = msgBase.replace(/\[nome\]/g, aluno.nome);
                statusLabel.innerText = `Enviando para ${aluno.nome} (${i+1}/${listaDestinatarios.length})...`;

                try {
                    await fetch(`${API_URL}/message/sendText/${INSTANCE}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'apikey': API_KEY },
                        body: JSON.stringify({
                            "number": fone,
                            "textMessage": { "text": msgFinal }
                        })
                    });
                } catch (e) { console.error("Erro no envio", e); }
                
                await new Promise(r => setTimeout(r, 2000)); 
            }
            statusLabel.innerText = "✓ Transmissão Finalizada!";
        }

        async function abrirModalConexao() {
            const modal = new bootstrap.Modal(document.getElementById('modalQR'));
            modal.show();
            try {
                await fetch(`${API_URL}/instance/create`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'apikey': API_KEY },
                    body: JSON.stringify({ "instanceName": INSTANCE, "token": API_KEY, "qrcode": true })
                });
                
                const res = await fetch(`${API_URL}/instance/connect/${INSTANCE}`, {
                    headers: { 'apikey': API_KEY }
                });
                const data = await res.json();
                if(data.code) {
                    document.getElementById('areaQR').innerHTML = `<img src="${data.base64}" class="img-fluid">`;
                } else {
                    document.getElementById('areaQR').innerHTML = "<span class='text-success'>Conectado!</span>";
                }
            } catch (e) {
                document.getElementById('areaQR').innerHTML = "Erro ao conectar ao servidor.";
            }
        }
    </script>
</body>
</html>
